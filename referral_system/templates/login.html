<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Подключаем jQuery для удобства -->
</head>
<body>

<h2>Login - Enter Phone Number</h2>

<!-- Форма для ввода номера телефона -->
<form id="phone-form" method="POST">
    {% csrf_token %}
    <label for="phone_number">Enter Phone Number:</label>
    <input type="text" name="phone_number" id="phone_number" required>
    <button type="submit">Send Code</button>
</form>

<!-- Раздел для отображения информации о коде -->
<div id="verification-status"></div>

<!-- Форма для ввода кода подтверждения -->
<form id="verify-form" method="POST" style="display: none;">
    {% csrf_token %}
    <label for="verify_code">Enter Verification Code:</label>
    <input type="text" name="verify_code" id="verify_code" required>
    <button type="submit">Activate Account</button>
</form>

<script>
    // Перехватываем отправку формы с номером телефона
    document.getElementById('phone-form').addEventListener('submit', function (event) {
        event.preventDefault();  // Останавливаем обычную отправку формы

        let phoneNumber = document.getElementById('phone_number').value;

        // Отправляем POST-запрос на сервер для отправки кода
        fetch('/send_code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ "phone_number": phoneNumber })
        })
        .then(response => response.json())
        .then(data => {
            // Если пользователь уже верифицирован, сразу перенаправляем его на страницу профиля
            if (data.detail && data.detail === "User is already verified.") {
                document.getElementById('verification-status').innerText = data.detail;

                // Здесь можно автоматически авторизовать пользователя на сайте и перенаправить на страницу профиля
                setTimeout(() => {
                    window.location.href = '/user_profile/'; // Перенаправляем на user_profile
                }, 3000);  // 3 секунды задержка
            } else {
                // Отображаем сообщение о том, что код отправляется
                document.getElementById('verification-status').innerText = "Verification code is being sent...";

                // Через 3 секунды отправляем GET-запрос на /get_last_code/
                setTimeout(() => {
                    fetch(`/get_last_code/?phone_number=${phoneNumber}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.verification_code) {
                            // Показываем последний код в поле
                            document.getElementById('verification-status').innerText = `Last verification code: ${data.verification_code}`;
                            // Показать форму для ввода кода подтверждения
                            document.getElementById('verify-form').style.display = 'block';
                        } else {
                            document.getElementById('verification-status').innerText = "No verification code found.";
                        }
                    });
                }, 3000); // Задержка 3 секунды
            }
        })
        .catch(error => {
            document.getElementById('verification-status').innerText = "Error occurred.";
        });
    });

    // Перехватываем отправку формы с кодом подтверждения
    document.getElementById('verify-form').addEventListener('submit', function (event) {
        event.preventDefault();  // Останавливаем обычную отправку формы

        let phoneNumber = document.getElementById('phone_number').value;
        let verifyCode = document.getElementById('verify_code').value;

        // Отправляем POST-запрос для активации аккаунта с введенным кодом
        fetch('/verify_code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                "phone_number": phoneNumber,
                "verification_code": verifyCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message && data.message === "User verified successfully!") {
                document.getElementById('verification-status').innerText = data.message;  // Сообщение об успешной верификации

                // 1. Отправляем запрос на авторизацию с номером телефона
                fetch('/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ "phone_number": phoneNumber })
                })
                .then(authResponse => authResponse.json())
                .then(authData => {
                    console.log("Authorization response:", authData);  // Выводим результат в консоль
                    console.log("Authorization response:", phoneNumber);
                    if (authData.access) {
                        // 2. Сохраняем токен в localStorage
                        localStorage.setItem('access_token', authData.access);
                        console.log("Token saved:", authData.access);  // Логируем сохраненный токен

                        // 3. Перенаправляем на страницу профиля
                        setTimeout(() => {
                            window.location.href = '/user_profile/';  // Перенаправляем на user_profile
                        }, 1000);
                    } else {
                        document.getElementById('verification-status').innerText = "Authorization failed.";
                        console.log("Authorization failed - no access token.");
                    }
                })
                .catch(error => {
                    document.getElementById('verification-status').innerText = "Error occurred during authorization.";
                    console.error("Authorization error:", error);
                });

            } else if (data.detail) {
                document.getElementById('verification-status').innerText = data.detail;  // Ошибка, если код неверный
            }
        })
        .catch(error => {
            document.getElementById('verification-status').innerText = "Error occurred during verification.";
            console.error("Verification error:", error);
        });
    });
</script>


</body>
</html>
